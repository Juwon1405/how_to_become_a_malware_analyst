# マルウェア解析者になるための勉強方法(work-in-progress)

`これは@PINKSAWTOOTHの私見で、必ずしもあなたにとって一番良い方法ではないかもしれません。勉強方法の一例として参照しもらえれば幸いです。`

これを読む前に、僕が尊敬するマルウェア解析者の@hasherezade氏がマルウェア解析の勉強をどのように始めたらよいかをブログにまとめています。
重複する部分があると思いますが、一読することをおすすめします。また、以下のブログは英語のソースが中心なので、可能な限り日本語を中心にしたソースを紹介したいと思います。

- https://hshrzd.wordpress.com/how-to-start/

# マルウェア解析の前提となる知識

まず、マルウェア解析の前提となる知識について簡単に説明します。
マルウェア解析について学ぶ前に、最低限コンピュータサイエンス(計算機科学)の知識が必要になります。

- コンピュータアーキテクチャ
- コンピュータネットワーク
- オペレーティングシステム
- プログラミング言語
- データ構造とアルゴリズム
- etc...

これらについては、大学や専門学校で履修する内容が理解できていればよいかと思います。
(どこかの大学のオンラインシラバス等を確認することで、より具体的な内容を知れるかと思います。)
本稿では、プログラミング言語やコンピュータサイエンスをどのように学ぶかはスコープ外としますが、以下がおすすめの資料です。

- [コンピュータはなぜ動くのか 知っておきたいハードウエア＆ソフトウエアの基礎知識](https://www.nikkeibp.co.jp/atclpubmkt/book/03/P81650/)
- [プログラムはなぜ動くのか 第３版　知っておきたいプログラミングの基礎知識](https://www.nikkeibp.co.jp/atclpubmkt/book/21/S00190/)
- [インテル® 64および IA-32 アーキテクチャのソフトウェア開発者向けマニュアル (最新)](https://software.intel.com/content/www/us/en/develop/articles/intel-sdm.html)
- [IA-32 インテル® アーキテクチャー・ソフトウェア・デベロッパーズ・マニュアル、上巻: 基本アーキテクチャー (日本語:古い)](http://www.intel.co.jp/content/dam/www/public/ijkk/jp/ja/documents/developer/IA32_Arh_Dev_Man_Vol1_Online_i.pdf)
- [IA-32 インテル® アーキテクチャー・ソフトウェア・デベロッパーズ・マニュアル、中巻 A: 命令セット・リファレンス A-M(日本語:古い)](http://www.intel.co.jp/content/dam/www/public/ijkk/jp/ja/documents/developer/IA32_Arh_Dev_Man_Vol2A_i.pdf)
- [IA-32 インテル® アーキテクチャー・ソフトウェア・デベロッパーズ・マニュアル、中巻 B: 命令セット・リファレンス N-Z(日本語:古い)](http://www.intel.co.jp/content/dam/www/public/ijkk/jp/ja/documents/developer/IA32_Arh_Dev_Man_Vol2B_i.pdf)
- [IA-32 インテル® アーキテクチャー・ソフトウェア・デベロッパーズ・マニュアル、下巻: システム・プログラミング・ガイド(日本語:古い)](http://www.intel.co.jp/content/dam/www/public/ijkk/jp/ja/documents/developer/IA32_Arh_Dev_Man_Vol3_i.pdf)
- [マスタリングTCP/IP 入門編（第6版](https://www.ohmsha.co.jp/book/9784274224478/)
- [CS50.jp](https://cs50.jp/)
- [CS50x](https://cs50.harvard.edu/x/2021/)

# マルウェア解析に必要となる知識

マルウェア解析に必要となる知識を大きく以下の5つに分けます。

- マルウェア解析技術、マルウェアの挙動、悪用するテクニックの実装や実現方法に関する知識
- リバースエンジニアリング対象のプログラム開発に関する知識
- リバースエンジニアリングに関する知識
- 解析ツールに関する知識

## マルウェア解析技術、マルウェアの挙動、悪用するテクニックの実装や実現方法に関する知識

まずはマルウェアとはなにか、マルウェア解析とは何を行う作業なのかを学ぶ必要があります。
マルウェア解析全般について学ぶのにおすすめの資料、書籍を紹介します。

- [セキュリティ・キャンプ全国大会2015でのマルウエア分析講義](https://blogs.jpcert.or.jp/ja/2015/09/seccamp.html)
  - 中津留氏(@you0708)によるセキュリティ・キャンプ全国大会2015で開催されたマルウェア解析の講義です。
- [初めてのマルウェア解析](https://www.oreilly.co.jp/books/9784873119298/)
  - 日本語でマルウェア解析全般の基礎から発展的な内容まで取り扱っている本です。
- [リバースエンジニアリングツールGhidra実践ガイド](https://book.mynavi.jp/ec/products/detail/id=116258)
  - 私も著者に入っているGhidraを使った静的解析を通じてマルウェアの実装を学べる本です。 
- [リバースエンジニアリング入門 ＠IT連載](https://www.atmarkit.co.jp/ait/series/2614/)
  - 日本電信電話株式会社の川古谷氏、青木氏、岩村氏によるシェルコードの解析を解説した記事。
- [アナライジング・マルウェア](https://www.oreilly.co.jp/books/9784873114552/)
  - 2010年発行のため内容は古くなってしまっていますが、アセンブリを読まないという縛りでマルウェア解析について触れられている珍しい本です。 
- [MWS Cup](https://www.iwsec.org/mws/mwscup.html) 
  - 情報処理学会コンピュータセキュリティ(CSEC)研究会配下のMWS組織員会が主催するマルウェア解析技術を競うコンテスト。過去の問題内容や解説が公開されており参考になります。
- [CS6038/CS5138 Malware Analysis, UC](https://class.malware.re/)
  - University of Cincinnati のマルウェア解析講義資料。毎年内容が更新されており、演習用のサンプルも配布されているためおすすめです。無償で公開されている。
- [Practical Malware Analysis](https://nostarch.com/malware)
  - マルウェア解析全般について詳細に解説された洋書。サンプルと解答が公開されているため演習を行いながら学べる。
- [malware_training_vol1 by hasherezade](https://github.com/hasherezade/malware_training_vol1)
  - @hasherezade氏によるマルウェア解析トレーニング資料。WIPだが、演習用のサンプルも配布されているためおすすめです。
- [Malware Analysis - CSCI 4976](https://github.com/RPISEC/Malware)
  - Rensselaer Polytechnic Instituteのマルウェア解析講義資料。演習用のサンプルも配布されています。
- [Workshop by Malware Unicorn](https://malwareunicorn.org/#/workshops)
  - @malwareunicorn氏によるリバースエンジニアリングのワークショップ資料
- [Youtube channel by SANS Digital Forensics and Incident Response](https://www.youtube.com/c/SANSDigitalForensics)
  - 世界的に有名なセキュリティトレーニングSANSのDFIR関連のYoutubeチャンネル
- [Youtube channel by OALabs](https://www.youtube.com/c/OALabs/videos)
  - OALabsによるマルウェア解析動画を中心としたYoutubeチャンネル
- [Youtube channel by hasherezade](https://www.youtube.com/c/hasherezade)
  - hasherezade氏によるマルウェア解析動画を中心としたYoutubeチャンネル 
- [RecommendationofPerfectUnpacking](https://www.jpcert.or.jp/present/2014/20140424ssmjp.pdf)
  - 中津留氏(@you0708)によるアンパック手法の資料
- [同人誌 by Allsafe](https://allsafe.booth.pm/)
  - 私が所属するリバースエンジニアリングやマルウェア解析技術を主にした同人サークルAllsafeの同人誌
- [Malware Analysis at Scale ~ Defeating EMOTET by Ghidra ~ by Allsafe](https://jsac.jpcert.or.jp/archive/2021/pdf/JSAC2021_workshop_malware-analysis_jp.pdf)
  - AllsafeによるEmotet解析ワークショップ資料  
  - [配布スクリプト](https://github.com/AllsafeCyberSecurity/malware-analysis-at-scale-defeating-emotet-by-ghidra)
- [Advanced Binary Deobfuscation](https://github.com/malrev/ABD)
  - @ntddk氏によるGCC Tokyo、セキュリティ・キャンプ全国大会2020のバイナリ難読化とその解除技術の講義 
- [MÖBIUS STRIP REVERSE ENGINEERING](https://www.msreverseengineering.com/)
  - CS系の知見とIDAの内部構造を活かした解析記事が豊富 recommended by ntddk。 

マルウェア解析のオンライントレーニングもおすすめです。

- [The Beginner Malware Analysis Course](https://0verfl0w.podia.com/courses/malware-analysis-course)
  - @0verfl0w氏によるマルウェア解析入門トレーニング
- [From Zero to Hero](https://www.sentinelone.com/lp/zero-to-hero-2021)
 - @0verfl0w氏と@vk_intel氏による実践的なマルウェア解析トレーニング 
- [Zero2Automated](https://courses.zero2auto.com/)
 - @0verfl0w氏と@vk_intel氏による、発展的なマルウェア解析トレーニング  

マルウェアの挙動、悪用するテクニックについてまとめられているページを紹介します。
- [Snoozy by ry0kvn](https://snoozy.hatenablog.com/)
  - @ry0kvn氏のブログ。マルウェアが使用するテクニックの実装などに触れられている。 
- [MITRE ATT&CK](https://attack.mitre.org/)
  - 攻撃の手法やテクニック、手順がフレームワークとして定義されており、マルウェア解析だけでなくサイバー攻撃全般について学ぶのに良い。
- [ired.team](https://www.ired.team/)
  - ペンテスター、レッドチーム、攻撃者が使用するテクニックとその実装の紹介
- [malpedia](https://malpedia.caad.fkie.fraunhofer.de/)
  - マルウェアのファミリ毎に、解析レポートがまとめられている。 
- [Ten process injection techniques: A technical survey of common and trending process injection techniques](https://www.elastic.co/jp/blog/ten-process-injection-techniques-technical-survey-common-and-trending-process)
  - コードインジェクションテクニックの紹介
- [Code Injection demos by hasherezade](https://github.com/hasherezade/demos)
  - コードインジェクションテクニックの実装
- [Evasion techniques by cpr](https://evasions.checkpoint.com/)
  - マルウェアの解析回避テクニックまとめ 
- [Al-Khaser](https://github.com/LordNoteworthy/al-khaser)
  - マルウェアのアンチ解析機能を実装したOSSツールとソースコード

日々公開されている脅威情報やマルウェア解析を扱ったブログやレポートも重要な情報源になります。RSSリーダなどで更新を通知しておくと便利です。
それらをまとめているサイトもあるので、活用することができます。

- [AlienVault - Open Threat Exchange](https://otx.alienvault.com/)
- [APT & Cybercriminals Campaign Collection](https://github.com/CyberMonitor/APT_CyberCriminal_Campagin_Collections)

これらの中で日本語でマルウェアの詳細な解析を取り上げているものを紹介しておきます。

- [Japan Security Analyst Conference](https://jsac.jpcert.or.jp/)
- [JPCERTコーディネーションセンター公式ブログ](https://blogs.jpcert.or.jp/ja/malware/)
- [LACレポート by 石川 芳浩氏](https://www.lac.co.jp/lacwatch/author_ishikawa/)
- [標的型攻撃の実態と対策アプローチ by マクニカネットワークス(最新記事をリンク)](https://www.macnica.net/mpressioncss/feature_07.html/)
- [NTT Security Japan Technical blog ](https://insight-jp.nttsecurity.com/)
- [MBSD Blog](https://www.mbsd.jp/research/malware/#contents)
- [fortinetブログ 脅威リサーチ](https://www.fortinet.com/jp/blog/threat-research)
- [Unit42ブログ](https://unit42.paloaltonetworks.jp/#all)
- [トレンドマイクロ セキュリティブログ](https://blog.trendmicro.co.jp/)

他にも、YaraやCapaのルールを読むことで、マルウェアの特徴や機能について学習することができます。
- [コミュニティのYaraルール](https://github.com/Yara-Rules/rules)
- [Neo23x0のYaraルール](https://github.com/Neo23x0/signature-base/tree/master/yara)
- [CAPEv2のYaraルール](https://github.com/kevoreilly/CAPEv2/tree/master/data/yara)​
- [ESETのYaraルール](https://github.com/eset/malware-ioc/)​
- [JPCERTのYaraルール](https://github.com/JPCERTCC/jpcert-yara)​
- [awesome-yara](https://github.com/InQuest/awesome-yara)
- [Capaのルール](https://github.com/mandiant/capa-rules)

## リバースエンジニアリング対象のプログラム開発に関する知識

リバースエンジニアリングは、マルウェア解析において一部でしかありませんが、マルウェア解析者になるためには避けて通れない道です。
サンドボックスを使った動的解析やツールを使った動的解析(手動でおこなうデバッグを除く)だけでは、マルウェアの機能の全容や使用されているアルゴリズムを特定することは困難です。

リバースエンジニアリングをおこなうためには、元のソースコードについて理解しておく必要があります。
（マルウェア解析で一般的なWindows環境を想定しますが）Windows APIを使ったプログラミングの経験なしにマルウェア解析をするのは遠回りになるでしょう。

幸いなことにWindows APIはMicrosoftが公式のドキュメントを公開しており、詳細についてはWeb上で確認することができます。
`日本語のページがある場合がありますが、英語のページのほうが記載が充実しています。Google翻訳を使ってもいいので英語版を読むようにしましょう。`

- https://docs.microsoft.com/en-us/

例としてCreateFile関数の[ページ](https://docs.microsoft.com/ja-jp/windows/win32/api/fileapi/nf-fileapi-createfilea)を記載します。

![image](https://user-images.githubusercontent.com/18203311/120811986-89e9f480-c587-11eb-8bb0-61c8d4e10a91.png)

また、Windows APIのサンプルも同ページに記載されている場合があります。こういったサンプルのコードを参考にプログラムを作成してみましょう。　　

![image](https://user-images.githubusercontent.com/18203311/120793123-792e8400-c571-11eb-836b-2b7f2305fb8c.png)
![image](https://user-images.githubusercontent.com/18203311/120795426-68cbd880-c574-11eb-8c07-923b07d91803.png)

MicrosoftのGitHubには[Windows APIを使用したサンプルを公開しているページ](https://github.com/microsoft/Windows-classic-samples)があります。こちらも参考にしてみてください。

WindowsのOSの仕組みを学ぶのには以下の書籍がおすすめです。
- [インサイドWindows　第7版 上](https://www.nikkeibp.co.jp/atclpubmkt/book/18/P53570/)
- [インサイドWindows　第6版 上](https://www.nikkeibp.co.jp/atclpubmkt/book/12/P94700/) 
- [インサイドWindows　第6版 下](https://www.nikkeibp.co.jp/atclpubmkt/book/13/P94710/) 

## リバースエンジニアリングに関する知識

解析対象の言語や環境でのプログラミング技術が身についたら、リバースエンジニアリングについて勉強していきましょう。
まずはマルウェア解析で一般的なWindowsのPEファイルを解析する場合、まずはCやC++の入門プログラムをリバースエンジニアリングしてみましょう。
次にのステップとしては、自分でコンパイルした(ソースコードが存在する)Win APIを使ったPEファイルを解析してみましょう。同じソースコードでも、選択するプロジェクトやコンパイルやリンクのオプションなどを変更して、実行ファイルにどういった変化が現れるかまで見ておけば、リバースエンジニアリング技術がかなり付くと思います。

マルウェア解析を目的としてリバースエンジニアリングを学ぶ上での資料、書籍を紹介します。(前述の項目で紹介した内容に含まれているので、ここではリバースエンジニアリングに特化したものを紹介します。)

- [リバースエンジニアリングバイブル](https://book.impress.co.jp/books/1113101030)
- [デバッガによるx86プログラム解析入門【x64対応版](https://www.shuwasystem.co.jp/book/9784798042053.html)

さらにリバースエンジニアリング技術を磨くににはCTFのRev問やCrackmeを解くと良いでしょう。
特にPEファイルの問題やマルウェア解析者を対象としたものが、おすすめです。

- [The Flare On Challenge](https://flare-on.com/)
  - FireEyeのマルウェア解析チームflareによるマルウェア解析技術にフォーカスしたCTF。
- [Beginner Malware Reversing Challenges by MalwareTech](https://www.malwaretech.com/beginner-malware-reversing-challenges)
  - MalwareTech氏によるマルウェア解析初心者向け演習問題
- [reversing.kr](http://reversing.kr/challenge.php)
  - PE形式が多いCrackMe配布サイト
- [crackmes.one](https://crackmes.one/)
  - CrackMe投稿サイト 

また、マルウェアのリバースエンジニアリングでは暗号アルゴリズムの処理をリバースエンジニアリングすることが多いので基本的な暗号技術について学ぶことを推奨します。
アルゴリズムを理解したらGitHubなどで公開されているオープンソースの暗号アルゴリズム実装のソースコードを読み、実際にリバースエンジニアリングしてみましょう。

- [暗号技術入門 第3版](https://www.sbcr.jp/product/4797382228/)
- [OpenSSL Project](https://github.com/openssl/openssl)
- [Network Security Services](https://github.com/nss-dev/nss)
- [Crypto++ Library](https://github.com/weidai11/cryptopp)
- [wolfSSL](https://github.com/wolfSSL/wolfssl)

## 解析ツールに関する知識

マルウェア解析をすすめるうえで、よりよいツールを使うことやツールを使いこなすことで容易に解析できることがあります。
また、様々な知識を持っていても実際にツールを通して解析するため、ツールの利用方法も理解しておく必要があります。

解析ツールのインストールや更新などの管理のために、FireEyeが[Flare VM](https://github.com/fireeye/flare-vm)をリリースしておりWindowsの仮想環境上で簡単に解析ツールの管理をおこなうことができます。
[Flare VMによってインストールされるツールの一覧](https://github.com/fireeye/flare-vm)を確認し、それぞれの使い方を学ぶことでマルウェア解析者に一般的に利用されるソフトウェアを使いこなすことができます。

また、以下のリンクで紹介されているツールについても利用してみるとよいでしょう。

- [awesome-reversing](https://github.com/tylerha97/awesome-reversing)
- [Awesome Malware Analysis](https://github.com/rshipp/awesome-malware-analysis)
- [Awesome Ghidra](https://github.com/AllsafeCyberSecurity/awesome-ghidra)

## マルウェアの入手

## 前置き

ここではマルウェアの入手方法について触れますが、紹介するサービスを利用する際は利用規約を必ず読んで利用してください。
また、以下の内容は、マルウェアの入手を勧めるものではありません。

正当な理由なくマルウェア(法律的には不正指令電磁的記録)を作成、取得・保管することは法律で禁止されています。
どういった理由であれば法律上の`正当な理由`にあたるかは、法律の専門家ではないためわかりません。
個人の趣味でマルウェア解析をおこなうことは`正当な理由`として認めら得ない可能性もあります。
捜査されると困る、裁判になったら困る、正当な理由として提示できる活動実績がない、弁護費用がないなど、平穏な人生を絶対に送りたいという人は、個人の趣味でやらないほうがよいかと思います。

とはいえ過度に怯えすぎて萎縮する必要はないとは思います。
最低限、警視庁が公開している不正指令電磁的記録に関する罪に関するページには目を通して、内容を確認しておきましょう。

- https://www.keishicho.metro.tokyo.jp/kurashi/cyber/law/virus.html

マルウェアを扱う上で気にしなければ行けないことは、法律面だけではありません。
マルウェアを実行(故意かどうかは問わない)すると、たいていの場合は攻撃者の用意したサーバにアクセスします。
攻撃者のサーバには自分の利用しているIPアドレスのログが残りますし、接続時に利用しているシステムの情報を送信することもあります。
マルウェアによっては、攻撃者によるコマンドの実行などがおこなわれることも考えられますし、内部ネットワークのスキャンや(一番避けるべき)外部への感染活動などがおこなわれるかもしれません。
攻撃者のサーバに記録された情報は攻撃者自身だけでなく、第三者へ提供されることもあります。また、捜査機関はサーバを差し押さえてログを解析したうえで、ISPに情報開示請求をおこなうことができます。

以下のどれか一つにでも当てはまる場合は、実際のマルウェアを利用した学習は控えましょう。

- マルウェアを取り扱う上で、不安がある。
- マルウェア解析のための専用PCや独立したネットワークなど隔離した環境を用意できない。
- 未成年もしくは学生であるが、マルウェアを扱った解析や研究をするうえで責任者がいない(社会人の場合は、全て自己責任として責任を取れない)。

実際のマルウェアを個人的に入手しなくても、学習する方法は前述しております。
オタクがみんな大好きな以下の名言たちで前置きを終えます。
- `With great power comes great responsibility`
- `The abyss gazes also into you.`

## マルウェア共有サービス/IoC共有サービス

マルウェアのサンプルやIoCを共有するためのサービスがいくつかあります。もっとも登録が多く有名なサービスはVirusTotalですが、有償アカウントのみダウンロードが可能であるため、ここでは無償で利用可能なサービスを紹介します。

- [malpedia](https://malpedia.caad.fkie.fraunhofer.de/)
- [MalwareBazaar](https://bazaar.abuse.ch/)
- [URLhaus](https://urlhaus.abuse.ch/)
- [ThreatFox](https://threatfox.abuse.ch/)
- [MalShare](https://www.malshare.com/)
- [VirusShare](https://virusshare.com/)
- [VirusBay](https://beta.virusbay.io/)
- [Vx Vaul](http://vxvault.net//ViriList.php)
- [theZoo](https://thezoo.morirt.com/)
- [vx-underground](https://www.vx-underground.org/)

## オンラインサンドボックス

無料で使用できるオンラインサンドボックスのサービスは本来マルウェアの挙動を解析するサービスですが、他者の投稿したマルウェアをダウンロードすることができます。

- [Hybrid Analysis](https://www.hybrid-analysis.com/)
- [Any Run](https://app.any.run/)
- [Triage](https://tria.ge/)
- [Joe Sandbox](https://www.joesandbox.com/)
- [cape](https://capesandbox.com/)
- [Cuckoo Sandbox](https://cuckoo.cert.ee/)

## OSS
- [Lilith RAT](https://github.com/werkamsus/Lilith)
- [Quasar RAT](https://github.com/quasar/Quasar)
- [NGLite](https://github.com/Maka8ka/NGLite)
- [AsyncRAT](https://github.com/NYAN-x-CAT/AsyncRAT-C-Sharp)
- [trochilus RAT](https://github.com/5loyd/trochilus)
- [gh0st RAT](https://github.com/sin5678/gh0st)
- [Poison-Ivy-Reload](https://github.com/killeven/Poison-Ivy-Reload)
- [GitHub Topics rat](https://github.com/topics/rat)
